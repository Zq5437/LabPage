# 实验室网站部署指南

## 📋 部署前检查清单

- ✅ Nginx 已安装
- ✅ Cpolar 已安装并有固定地址
- ✅ MySQL 已安装并运行
- ✅ Node.js 已安装

## 🚀 部署步骤

### 1. 配置数据库

```bash
# 启动 MySQL
brew services start mysql

# 导入数据库
mysql -u root -p < database/schema.sql
```

### 2. 配置后端环境变量

确保 `backend/.env` 文件配置正确：
```bash
DB_HOST=localhost
DB_PORT=3306
DB_DATABASE=lab_website
DB_USER=root
DB_PASSWORD=你的MySQL密码
JWT_SECRET=你的JWT密钥
SERVER_PORT=5080
```

### 3. 构建前端项目

```bash
# 构建前端展示页面
cd frontend
npm install
npm run build

# 构建管理后台
cd ../admin
npm install
npm run build
```

### 4. 启动后端服务

```bash
cd backend
npm install
npm start
# 或使用 PM2（推荐生产环境）
npm install -g pm2
pm2 start server.js --name LabPage_backend
pm2 save
```

### 5. 启动 Nginx

```bash
# 测试配置是否正确
sudo nginx -t

# 启动或重启 nginx
sudo brew services restart nginx

# 查看状态
sudo brew services list
```

### 6. 配置 Cpolar 内网穿透

```bash
# 启动 cpolar，穿透本地 80 端口
cpolar http 80

# 或使用固定域名（如果你有）
cpolar http -subdomain=你的固定域名 80
```

## 🌐 访问地址

- **前端网站**: http://localhost/ 或你的cpolar域名
- **管理后台**: http://localhost/admin 或你的cpolar域名/admin
- **后端API**: http://localhost/api

## 📝 管理命令

### Nginx 管理
```bash
# 重启
sudo brew services restart nginx

# 停止
sudo brew services stop nginx

# 查看日志
tail -f /opt/homebrew/var/log/nginx/lab_website.access.log
tail -f /opt/homebrew/var/log/nginx/lab_website.error.log
```

### 后端管理（使用PM2）
```bash
# 查看状态
pm2 status

# 重启
pm2 restart LabPage_backend

# 查看日志
pm2 logs LabPage_backend

# 停止
pm2 stop LabPage_backend
```

### MySQL 管理
```bash
# 启动
brew services start mysql

# 停止
brew services stop mysql

# 重启
brew services restart mysql
```

## 🔧 常见问题

### 1. Nginx 无法启动
- 检查80端口是否被占用：`lsof -i :80`
- 如果Apache在运行，停止它：`sudo apachectl stop`

### 2. 后端API无法访问
- 确保后端服务在5080端口运行：`lsof -i :5080`
- 检查后端日志查看错误信息

### 3. 上传文件无法显示
- 确保 uploads 目录有读取权限
- 检查 nginx 配置中的 uploads 路径是否正确

### 4. 管理后台无法访问
- 清除浏览器缓存
- 检查 admin/dist 目录是否存在
- 重新构建管理后台：`cd admin && npm run build`

## 🔒 安全建议

1. **修改默认密码**：登录后立即修改管理员密码
2. **配置防火墙**：只开放必要的端口
3. **定期备份**：定期备份数据库和上传文件
4. **更新依赖**：定期更新 npm 包和系统软件

## 📊 性能优化

1. **启用 Nginx Gzip**：在 nginx.conf 中取消注释 `gzip on;`
2. **使用 PM2 集群模式**：`pm2 start server.js -i max`
3. **定期清理日志**：设置日志轮转

## 💡 快速命令

```bash
# 一键重启所有服务
sudo brew services restart nginx && pm2 restart LabPage_backend

# 查看所有服务状态
sudo brew services list && pm2 status

# 查看实时日志
pm2 logs LabPage_backend --lines 50
```

## 📞 默认管理员账号

- 用户名: `admin`
- 密码: `admin123`

**重要：首次登录后请立即修改密码！**

