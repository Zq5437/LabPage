<template>
  <div class="page-container">
    <el-card>
      <template #header>
        <div class="header-row">
          <h3>ÊàêÂëòÁÆ°ÁêÜ</h3>
          <el-button type="primary" @click="showCreateDialog">
            <el-icon>
              <Plus />
            </el-icon>
            Ê∑ªÂä†ÊàêÂëò
          </el-button>
        </div>
      </template>

      <!-- ÊêúÁ¥¢ÂíåÁ≠õÈÄâ -->
      <div class="filter-row">
        <div class="filter-left">
          <el-input v-model="searchQuery" placeholder="ÊêúÁ¥¢ÊàêÂëòÂßìÂêç..." style="width: 250px" clearable @input="handleSearch">
            <template #prefix>
              <el-icon>
                <Search />
              </el-icon>
            </template>
          </el-input>
        </div>

        <div class="filter-right">
          <el-select v-model="filters.category" placeholder="ÈÄâÊã©Á±ªÂà´" clearable style="width: 130px; margin-right: 10px"
            @change="loadMembers">
            <el-option label="ÊïôÂ∏à" value="faculty" />
            <el-option label="ÂçöÂ£´Âêé" value="postdoc" />
            <el-option label="ÂçöÂ£´Áîü" value="phd" />
            <el-option label="Á°ïÂ£´Áîü" value="master" />
            <el-option label="Êú¨ÁßëÁîü" value="undergraduate" />
            <el-option label="Ê†°Âèã" value="alumni" />
          </el-select>

          <el-select v-model="filters.status" placeholder="ÈÄâÊã©Áä∂ÊÄÅ" clearable style="width: 120px" @change="loadMembers">
            <el-option label="Ê¥ªË∑É" value="active" />
            <el-option label="ÈùûÊ¥ªË∑É" value="inactive" />
            <el-option label="Ê†°Âèã" value="alumni" />
          </el-select>
        </div>
      </div>

      <!-- Êï∞ÊçÆË°®Ê†º -->
      <el-table :data="members" v-loading="loading" style="width: 100%" @sort-change="handleSort">
        <el-table-column prop="id" label="ID" width="60" sortable="custom" />

        <el-table-column label="Â§¥ÂÉè" width="80">
          <template #default="{ row }">
            <el-avatar :size="50" :src="row.avatar" :icon="UserFilled" style="border: 1px solid #dcdfe6" />
          </template>
        </el-table-column>

        <el-table-column prop="name" label="ÂßìÂêç" min-width="120" sortable="custom">
          <template #default="{ row }">
            <div>
              <div style="font-weight: 500">{{ row.name }}</div>
              <div style="font-size: 12px; color: #999; font-style: italic">{{ row.name_en }}</div>
            </div>
          </template>
        </el-table-column>

        <el-table-column prop="title" label="ËÅå‰Ωç" min-width="150" />

        <el-table-column prop="category" label="Á±ªÂà´" width="100">
          <template #default="{ row }">
            <el-tag :type="getCategoryTagType(row.category)" size="small">
              {{ getCategoryText(row.category) }}
            </el-tag>
          </template>
        </el-table-column>

        <el-table-column prop="email" label="ÈÇÆÁÆ±" min-width="180" />

        <el-table-column prop="research_interests" label="Á†îÁ©∂ÂÖ¥Ë∂£" min-width="200">
          <template #default="{ row }">
            <div v-if="row.research_interests" class="interests-tags">
              <el-tag v-for="interest in getInterests(row.research_interests)" :key="interest" size="small"
                style="margin-right: 4px; margin-bottom: 4px" effect="light">
                {{ interest }}
              </el-tag>
            </div>
            <span v-else style="color: #ccc">-</span>
          </template>
        </el-table-column>

        <el-table-column prop="sort_order" label="ÊéíÂ∫è" width="80" sortable="custom" />

        <el-table-column prop="status" label="Áä∂ÊÄÅ" width="80">
          <template #default="{ row }">
            <el-tag :type="getStatusTagType(row.status)" size="small">
              {{ getStatusText(row.status) }}
            </el-tag>
          </template>
        </el-table-column>

        <el-table-column prop="created_at" label="ÂàõÂª∫Êó∂Èó¥" width="180" sortable="custom">
          <template #default="{ row }">
            {{ formatDate(row.created_at) }}
          </template>
        </el-table-column>

        <el-table-column label="Êìç‰Ωú" width="200" fixed="right">
          <template #default="{ row }">
            <el-button type="primary" size="small" @click="editMember(row)">
              <el-icon>
                <Edit />
              </el-icon>
              ÁºñËæë
            </el-button>
            <el-button type="danger" size="small" @click="deleteMember(row)">
              <el-icon>
                <Delete />
              </el-icon>
              Âà†Èô§
            </el-button>
          </template>
        </el-table-column>
      </el-table>

      <!-- ÂàÜÈ°µ -->
      <div class="pagination-row">
        <el-pagination v-model:current-page="pagination.page" v-model:page-size="pagination.limit"
          :page-sizes="[10, 20, 50, 100]" :total="pagination.total" layout="total, sizes, prev, pager, next, jumper"
          @size-change="handleSizeChange" @current-change="handlePageChange" />
      </div>
    </el-card>

    <!-- ÂàõÂª∫/ÁºñËæëÂØπËØùÊ°Ü -->
    <el-dialog v-model="dialogVisible" :title="editingMember ? 'ÁºñËæëÊàêÂëò' : 'Ê∑ªÂä†ÊàêÂëò'" width="700px" destroy-on-close>
      <el-form ref="formRef" :model="formData" :rules="formRules" label-width="100px">
        <el-row :gutter="20">
          <el-col :span="12">
            <el-form-item label="‰∏≠ÊñáÂßìÂêç" prop="name">
              <el-input v-model="formData.name" placeholder="ËØ∑ËæìÂÖ•‰∏≠ÊñáÂßìÂêç" />
            </el-form-item>
          </el-col>
          <el-col :span="12">
            <el-form-item label="Ëã±ÊñáÂßìÂêç" prop="name_en">
              <el-input v-model="formData.name_en" placeholder="ËØ∑ËæìÂÖ•Ëã±ÊñáÂßìÂêç" />
            </el-form-item>
          </el-col>
        </el-row>

        <el-form-item label="Âà´Âêç/ÂÖ∂‰ªñÂêçÂ≠ó">
          <el-input v-model="formData.aliases" type="textarea" :rows="2"
            placeholder="ËØ∑ËæìÂÖ•ËØ•ÊàêÂëòÁöÑÂÖ∂‰ªñÂèØËÉΩÂêçÂ≠óÔºåÁî®ÂàÜÂè∑ÂàÜÈöî„ÄÇ‰æãÂ¶ÇÔºöZhang, Q.; Q. Zhang; Âº†Áê™; Qi Zhang; „ÉÅ„Éß„Ç¶ „Ç≠" />
          <div style="font-size: 12px; color: #999; margin-top: 4px;">
            üí° Áî®‰∫éËÆ∫Êñá‰ΩúËÄÖÊô∫ËÉΩÂåπÈÖç„ÄÇÂèØ‰ª•ÂåÖÂê´ÔºöÊãºÈü≥„ÄÅÁº©ÂÜô„ÄÅÊó•ÊñáÂêç„ÄÅÂÖ∂‰ªñËØ≠Ë®ÄÂêçÁ≠â„ÄÇÁî®ÂàÜÂè∑Ôºà;ÔºâÂàÜÈöî
          </div>
        </el-form-item>

        <el-row :gutter="20">
          <el-col :span="12">
            <el-form-item label="Á±ªÂà´" prop="category">
              <el-select v-model="formData.category" placeholder="ÈÄâÊã©Á±ªÂà´" style="width: 100%"
                @change="handleCategoryChange">
                <el-option label="ÊïôÂ∏à" value="faculty" />
                <el-option label="ÂçöÂ£´Âêé" value="postdoc" />
                <el-option label="ÂçöÂ£´Áîü" value="phd" />
                <el-option label="Á°ïÂ£´Áîü" value="master" />
                <el-option label="Êú¨ÁßëÁîü" value="undergraduate" />
                <el-option label="Ê†°Âèã" value="alumni" />
              </el-select>
            </el-form-item>
          </el-col>
          <el-col :span="12">
            <el-form-item :label="getTitleLabel(formData.category)" prop="title">
              <el-input v-model="formData.title" :placeholder="getTitlePlaceholder(formData.category)" />
            </el-form-item>
          </el-col>
        </el-row>

        <!-- Â≠¶ÁîüÁâπÊúâÂ≠óÊÆµÔºöÂπ¥Á∫ß -->
        <el-row :gutter="20" v-if="isStudent(formData.category)">
          <el-col :span="12">
            <el-form-item label="Âπ¥Á∫ß">
              <el-input v-model="formData.grade" placeholder="‰æãÂ¶ÇÔºö2023Á∫ß" />
            </el-form-item>
          </el-col>
          <el-col :span="12" v-if="formData.category === 'undergraduate'">
            <el-form-item label="‰∏ì‰∏ö">
              <el-input v-model="formData.major" placeholder="ËØ∑ËæìÂÖ•‰∏ì‰∏ö" />
            </el-form-item>
          </el-col>
        </el-row>

        <!-- Â≠¶Áîü/ÂçöÂ£´ÂêéÁâπÊúâÂ≠óÊÆµÔºöÂØºÂ∏à -->
        <el-row :gutter="20" v-if="isStudent(formData.category) || formData.category === 'postdoc'">
          <el-col :span="24">
            <el-form-item :label="formData.category === 'postdoc' ? 'Âêà‰ΩúÂØºÂ∏à' : 'ÂØºÂ∏à'">
              <el-input v-model="formData.supervisor"
                :placeholder="formData.category === 'postdoc' ? 'ËØ∑ËæìÂÖ•Âêà‰ΩúÂØºÂ∏àÂßìÂêç' : 'ËØ∑ËæìÂÖ•ÂØºÂ∏àÂßìÂêç'" />
            </el-form-item>
          </el-col>
        </el-row>

        <el-row :gutter="20">
          <el-col :span="12">
            <el-form-item label="ÈÇÆÁÆ±" prop="email">
              <el-input v-model="formData.email" placeholder="ËØ∑ËæìÂÖ•ÈÇÆÁÆ±" />
            </el-form-item>
          </el-col>
          <el-col :span="12">
            <el-form-item label="ÁîµËØù">
              <el-input v-model="formData.phone" placeholder="ËØ∑ËæìÂÖ•ÁîµËØù" />
            </el-form-item>
          </el-col>
        </el-row>

        <el-form-item label="ÂäûÂÖ¨ÂÆ§">
          <el-input v-model="formData.office" placeholder="ËØ∑ËæìÂÖ•ÂäûÂÖ¨ÂÆ§" />
        </el-form-item>

        <el-form-item label="Â§¥ÂÉè">
          <el-upload class="avatar-uploader" :action="uploadUrl" :headers="uploadHeaders" :show-file-list="false"
            name="avatar" :before-upload="beforeAvatarUpload" :on-success="handleAvatarSuccess"
            :on-error="handleUploadError">
            <img v-if="formData.avatar" :src="formData.avatar" class="avatar" />
            <el-icon v-else class="avatar-uploader-icon">
              <Plus />
            </el-icon>
          </el-upload>
        </el-form-item>

        <el-form-item label="‰∏™‰∫∫ÁÆÄ‰ªã">
          <el-input v-model="formData.bio" type="textarea" :rows="3" placeholder="ËØ∑ËæìÂÖ•‰∏™‰∫∫ÁÆÄ‰ªã" />
        </el-form-item>

        <el-form-item label="Á†îÁ©∂ÂÖ¥Ë∂£">
          <el-input v-model="formData.research_interests" placeholder="Â§ö‰∏™ÂÖ¥Ë∂£ËØ∑Áî®Ëã±ÊñáÈÄóÂè∑ÂàÜÈöî" />
        </el-form-item>

        <el-form-item label="ÊïôËÇ≤ËÉåÊôØ" v-if="formData.category !== 'undergraduate'">
          <el-input v-model="formData.education" type="textarea" :rows="2" placeholder="ËØ∑ËæìÂÖ•ÊïôËÇ≤ËÉåÊôØ" />
        </el-form-item>

        <!-- ÊïôÂ∏àÁâπÊúâÂ≠óÊÆµÔºöËç£Ë™âÁß∞Âè∑ -->
        <el-form-item label="Ëç£Ë™âÁß∞Âè∑" v-if="formData.category === 'faculty'">
          <el-input v-model="formData.honors" type="textarea" :rows="2" placeholder="ËØ∑ËæìÂÖ•Ëç£Ë™âÁß∞Âè∑„ÄÅËé∑Â•ñÊÉÖÂÜµÁ≠â" />
        </el-form-item>

        <!-- ÊïôÂ∏à/ÂçöÂ£´ÂêéÁâπÊúâÂ≠óÊÆµÔºöËÅå‰ΩçÂ±•ÂéÜ -->
        <el-form-item label="ËÅå‰ΩçÂ±•ÂéÜ" v-if="formData.category === 'faculty' || formData.category === 'postdoc'">
          <el-input v-model="formData.positions" type="textarea" :rows="4"
            placeholder="‰æãÂ¶ÇÔºö&#10;2022.12-  Lecturer, SSTC, Northeastern University, China&#10;2021.03-2022.04  Researcher, RIKEN, Japan" />
        </el-form-item>

        <!-- ÊïôÂ∏à/ÂçöÂ£´ÂêéÁâπÊúâÂ≠óÊÆµÔºöÂ≠¶ÊúØÊúçÂä° -->
        <el-form-item label="Â≠¶ÊúØÊúçÂä°" v-if="formData.category === 'faculty' || formData.category === 'postdoc'">
          <el-input v-model="formData.academic_service" type="textarea" :rows="4"
            placeholder="‰æãÂ¶ÇÔºö&#10;Reviewer of IEEE Transactions on...&#10;PC member of..." />
        </el-form-item>

        <!-- ÊïôÂ∏àÁâπÊúâÂ≠óÊÆµÔºöÊåáÂØºÂ≠¶ÁîüÊï∞ -->
        <el-form-item label="ÊåáÂØºÂ≠¶ÁîüÊï∞" v-if="formData.category === 'faculty'">
          <el-input-number v-model="formData.student_count" :min="0" :max="999" placeholder="ÂΩìÂâçÊåáÂØºÂ≠¶ÁîüÊï∞" />
        </el-form-item>

        <!-- Ê†°ÂèãÁâπÊúâÂ≠óÊÆµÔºöÂéüË∫´‰ªΩÂíåÂΩìÂâçÂéªÂêë -->
        <el-row :gutter="20" v-if="formData.category === 'alumni'">
          <el-col :span="12">
            <el-form-item label="Á¶ªÂºÄÂâçË∫´‰ªΩ">
              <el-select v-model="formData.alumni_category" placeholder="ÈÄâÊã©Ë∫´‰ªΩ" style="width: 100%">
                <el-option label="ÊïôÂ∏à" value="faculty" />
                <el-option label="ÂçöÂ£´Âêé" value="postdoc" />
                <el-option label="ÂçöÂ£´Áîü" value="phd" />
                <el-option label="Á°ïÂ£´Áîü" value="master" />
                <el-option label="Êú¨ÁßëÁîü" value="undergraduate" />
              </el-select>
            </el-form-item>
          </el-col>
          <el-col :span="12">
            <el-form-item label="ÂΩìÂâçÂéªÂêë">
              <el-input v-model="formData.current_position" placeholder="‰æãÂ¶ÇÔºöÊüêÊüêÂ§ßÂ≠¶ÂâØÊïôÊéà" />
            </el-form-item>
          </el-col>
        </el-row>

        <el-row :gutter="20">
          <el-col :span="8">
            <el-form-item label="‰∏™‰∫∫‰∏ªÈ°µ">
              <el-input v-model="formData.homepage" placeholder="‰∏™‰∫∫‰∏ªÈ°µÈìæÊé•" />
            </el-form-item>
          </el-col>
          <el-col :span="8">
            <el-form-item label="Google Scholar">
              <el-input v-model="formData.google_scholar" placeholder="Google ScholarÈìæÊé•" />
            </el-form-item>
          </el-col>
          <el-col :span="8">
            <el-form-item label="ORCID">
              <el-input v-model="formData.orcid" placeholder="ORCID" />
            </el-form-item>
          </el-col>
        </el-row>

        <el-row :gutter="20">
          <!-- ÊïôÂ∏à/ÂçöÂ£´ÂêéÔºöÂÖ•ËÅåÊó•Êúü -->
          <el-col :span="8" v-if="formData.category === 'faculty' || formData.category === 'postdoc'">
            <el-form-item :label="formData.category === 'postdoc' ? 'ÂÖ•Á´ôÊó•Êúü' : 'ÂÖ•ËÅåÊó•Êúü'">
              <el-date-picker v-model="formData.join_date" type="date" placeholder="ÈÄâÊã©Êó•Êúü" style="width: 100%"
                value-format="YYYY-MM-DD" />
            </el-form-item>
          </el-col>

          <!-- Â≠¶ÁîüÔºöÂÖ•Â≠¶Âπ¥‰ªΩ -->
          <el-col :span="8" v-if="isStudent(formData.category)">
            <el-form-item label="ÂÖ•Â≠¶Âπ¥‰ªΩ">
              <el-date-picker v-model="formData.join_date" type="year" placeholder="ÈÄâÊã©Âπ¥‰ªΩ" style="width: 100%"
                value-format="YYYY" />
            </el-form-item>
          </el-col>

          <!-- Â≠¶ÁîüÔºöÈ¢ÑËÆ°ÊØï‰∏öÊó•Êúü -->
          <el-col :span="8" v-if="isStudent(formData.category)">
            <el-form-item label="È¢ÑËÆ°ÊØï‰∏ö">
              <el-date-picker v-model="formData.expected_graduation_date" type="date" placeholder="ÈÄâÊã©Êó•Êúü"
                style="width: 100%" value-format="YYYY-MM-DD" />
            </el-form-item>
          </el-col>

          <!-- Ê†°Âèã/Á¶ªËÅåÔºöÁ¶ªÂºÄÊó•Êúü -->
          <el-col :span="8" v-if="formData.category === 'alumni' || formData.status === 'alumni'">
            <el-form-item label="Á¶ªÂºÄ/ÊØï‰∏öÊó•Êúü">
              <el-date-picker v-model="formData.graduation_date" type="date" placeholder="ÈÄâÊã©Êó•Êúü" style="width: 100%"
                value-format="YYYY-MM-DD" />
            </el-form-item>
          </el-col>

          <el-col :span="8">
            <el-form-item label="ÊéíÂ∫èÊùÉÈáç">
              <el-input-number v-model="formData.sort_order" :min="0" :max="999" style="width: 100%"
                placeholder="Êï∞Â≠óË∂äÂ§ßË∂äÈù†Ââç" />
            </el-form-item>
          </el-col>
        </el-row>

        <el-form-item label="Áä∂ÊÄÅ">
          <el-radio-group v-model="formData.status">
            <el-radio value="active">Ê¥ªË∑É</el-radio>
            <el-radio value="inactive">ÈùûÊ¥ªË∑É</el-radio>
            <el-radio value="alumni">Ê†°Âèã</el-radio>
          </el-radio-group>
        </el-form-item>
      </el-form>

      <template #footer>
        <el-button @click="dialogVisible = false">ÂèñÊ∂à</el-button>
        <el-button type="primary" :loading="saving" @click="saveMember">
          {{ editingMember ? 'Êõ¥Êñ∞' : 'ÂàõÂª∫' }}
        </el-button>
      </template>
    </el-dialog>
  </div>
</template>

<script setup>
import { ref, reactive, onMounted, computed, nextTick } from 'vue'
import { ElMessage, ElMessageBox } from 'element-plus'
import { Plus, Search, Edit, Delete, UserFilled } from '@element-plus/icons-vue'
import api from '@/utils/api'
import { useAuthStore } from '@/stores/auth'

// Áä∂ÊÄÅÁÆ°ÁêÜ
const authStore = useAuthStore()
const loading = ref(false)
const saving = ref(false)
const dialogVisible = ref(false)
const editingMember = ref(null)
const isLoadingData = ref(false) // Ê†áËÆ∞ÊòØÂê¶Ê≠£Âú®Âä†ËΩΩÊï∞ÊçÆ

// Êï∞ÊçÆ
const members = ref([])
const searchQuery = ref('')
const filters = reactive({
  category: '',
  status: ''
})

// ÂàÜÈ°µ
const pagination = reactive({
  page: 1,
  limit: 20,
  total: 0
})

// ÊéíÂ∫è
const sort = reactive({
  field: 'sort_order',
  order: 'DESC'
})

// Ë°®Âçï
const formRef = ref()
const formData = reactive({
  name: '',
  name_en: '',
  aliases: '',
  title: '',
  category: '',
  grade: '',
  major: '',
  supervisor: '',
  email: '',
  phone: '',
  office: '',
  avatar: '',
  bio: '',
  research_interests: '',
  education: '',
  honors: '',
  positions: '',
  academic_service: '',
  student_count: 0,
  current_position: '',
  alumni_category: '',
  homepage: '',
  google_scholar: '',
  orcid: '',
  join_date: '',
  graduation_date: '',
  expected_graduation_date: '',
  sort_order: 0,
  status: 'active'
})

const formRules = {
  name: [{ required: true, message: 'ËØ∑ËæìÂÖ•‰∏≠ÊñáÂßìÂêç', trigger: 'blur' }],
  category: [{ required: true, message: 'ËØ∑ÈÄâÊã©Á±ªÂà´', trigger: 'change' }],
  email: [{ type: 'email', message: 'ËØ∑ËæìÂÖ•Ê≠£Á°ÆÁöÑÈÇÆÁÆ±Ê†ºÂºè', trigger: 'blur' }]
}

// ‰∏ä‰º†ÈÖçÁΩÆ
const uploadUrl = computed(() => '/api/members/upload-avatar')
const uploadHeaders = computed(() => ({
  'Authorization': `Bearer ${authStore.token}`
}))

// ÊêúÁ¥¢Èò≤Êäñ
let searchTimeout = null

// Âä†ËΩΩÊàêÂëòÂàóË°®
const loadMembers = async () => {
  try {
    loading.value = true
    const params = {
      page: pagination.page,
      limit: pagination.limit,
      sort: sort.field,
      order: sort.order
    }

    if (filters.category) params.category = filters.category
    if (filters.status) params.status = filters.status
    if (searchQuery.value) params.search = searchQuery.value

    const response = await api.get('/members/admin/list', { params })

    if (response && response.data) {
      members.value = response.data.members || []
      pagination.total = response.data.pagination?.total || 0
    }
  } catch (error) {
    console.error('Âä†ËΩΩÊàêÂëòÂàóË°®Â§±Ë¥•:', error)
    ElMessage.error('Âä†ËΩΩÊàêÂëòÂàóË°®Â§±Ë¥•')
  } finally {
    loading.value = false
  }
}

// ÊêúÁ¥¢Â§ÑÁêÜ
const handleSearch = () => {
  if (searchTimeout) clearTimeout(searchTimeout)
  searchTimeout = setTimeout(() => {
    pagination.page = 1
    loadMembers()
  }, 500)
}

// ÊéíÂ∫èÂ§ÑÁêÜ
const handleSort = ({ prop, order }) => {
  sort.field = prop || 'sort_order'
  sort.order = order === 'ascending' ? 'ASC' : 'DESC'
  pagination.page = 1
  loadMembers()
}

// ÂàÜÈ°µÂ§ÑÁêÜ
const handleSizeChange = (size) => {
  pagination.limit = size
  pagination.page = 1
  loadMembers()
}

const handlePageChange = (page) => {
  pagination.page = page
  loadMembers()
}

// ÊòæÁ§∫ÂàõÂª∫ÂØπËØùÊ°Ü
const showCreateDialog = () => {
  editingMember.value = null
  resetForm()
  dialogVisible.value = true
}

// ÁºñËæëÊàêÂëò
const editMember = (member) => {
  editingMember.value = member
  isLoadingData.value = true // ËÆæÁΩÆÂä†ËΩΩÊï∞ÊçÆÊ†áÂøó

  Object.keys(formData).forEach(key => {
    // ‰ΩøÁî® ?? ËÄå‰∏çÊòØ ||ÔºåÈÅøÂÖç 0 ÂíåÁ©∫Â≠óÁ¨¶‰∏≤Ë¢´ËØØÂà§
    if (member[key] !== undefined && member[key] !== null) {
      formData[key] = member[key]
    } else if (key === 'sort_order' || key === 'student_count') {
      formData[key] = 0
    } else if (key === 'status') {
      formData[key] = 'active'
    } else {
      formData[key] = ''
    }
  })

  // ‰ΩøÁî® nextTick Á°Æ‰øùÊï∞ÊçÆÂä†ËΩΩÂÆåÊàêÂêéÂÜçÊ∏ÖÈô§Ê†áÂøó
  nextTick(() => {
    isLoadingData.value = false
  })

  dialogVisible.value = true
}

// ÈáçÁΩÆË°®Âçï
const resetForm = () => {
  Object.keys(formData).forEach(key => {
    formData[key] = key === 'sort_order' ? 0 : (key === 'status' ? 'active' : '')
  })
  if (formRef.value) {
    formRef.value.clearValidate()
  }
}

// ‰øùÂ≠òÊàêÂëò
const saveMember = async () => {
  try {
    await formRef.value.validate()
    saving.value = true

    const submitData = { ...formData }
    // Ê∏ÖÁêÜÁ©∫ÂÄº
    Object.keys(submitData).forEach(key => {
      if (submitData[key] === '') submitData[key] = null
    })

    if (editingMember.value) {
      await api.put(`/members/${editingMember.value.id}`, submitData)
      ElMessage.success('Êõ¥Êñ∞ÊàêÂëòÊàêÂäü')
    } else {
      await api.post('/members', submitData)
      ElMessage.success('ÂàõÂª∫ÊàêÂëòÊàêÂäü')
    }

    dialogVisible.value = false
    loadMembers()
  } catch (error) {
    console.error('‰øùÂ≠òÊàêÂëòÂ§±Ë¥•:', error)
    ElMessage.error('‰øùÂ≠òÊàêÂëòÂ§±Ë¥•')
  } finally {
    saving.value = false
  }
}

// Âà†Èô§ÊàêÂëò
const deleteMember = async (member) => {
  try {
    await ElMessageBox.confirm(
      `Á°ÆÂÆöË¶ÅÂà†Èô§ÊàêÂëò "${member.name}" ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ`,
      'Á°ÆËÆ§Âà†Èô§',
      {
        confirmButtonText: 'Á°ÆÂÆö',
        cancelButtonText: 'ÂèñÊ∂à',
        type: 'warning'
      }
    )

    await api.delete(`/members/${member.id}`)
    ElMessage.success('Âà†Èô§ÊàêÂëòÊàêÂäü')
    loadMembers()
  } catch (error) {
    if (error !== 'cancel') {
      console.error('Âà†Èô§ÊàêÂëòÂ§±Ë¥•:', error)
      ElMessage.error('Âà†Èô§ÊàêÂëòÂ§±Ë¥•')
    }
  }
}

// Â§¥ÂÉè‰∏ä‰º†
const beforeAvatarUpload = (file) => {
  const isImage = /^image\//.test(file.type)
  const isLt2M = file.size / 1024 / 1024 < 2

  if (!isImage) {
    ElMessage.error('Âè™ËÉΩ‰∏ä‰º†ÂõæÁâáÊñá‰ª∂!')
    return false
  }
  if (!isLt2M) {
    ElMessage.error('ÂõæÁâáÂ§ßÂ∞è‰∏çËÉΩË∂ÖËøá 2MB!')
    return false
  }
  return true
}

const handleAvatarSuccess = (response) => {
  if (response.success) {
    formData.avatar = response.data.avatar_url
    ElMessage.success('Â§¥ÂÉè‰∏ä‰º†ÊàêÂäü')
  } else {
    ElMessage.error('Â§¥ÂÉè‰∏ä‰º†Â§±Ë¥•')
  }
}

const handleUploadError = () => {
  ElMessage.error('Â§¥ÂÉè‰∏ä‰º†Â§±Ë¥•')
}

// Â∑•ÂÖ∑ÂáΩÊï∞
const getCategoryText = (category) => {
  const map = {
    faculty: 'ÊïôÂ∏à',
    postdoc: 'ÂçöÂ£´Âêé',
    phd: 'ÂçöÂ£´Áîü',
    master: 'Á°ïÂ£´Áîü',
    undergraduate: 'Êú¨ÁßëÁîü',
    alumni: 'Ê†°Âèã'
  }
  return map[category] || category
}

const getCategoryTagType = (category) => {
  const map = {
    faculty: 'danger',
    postdoc: 'warning',
    phd: 'primary',
    master: 'success',
    undergraduate: 'info',
    alumni: ''
  }
  return map[category] || ''
}

const getStatusText = (status) => {
  const map = {
    active: 'Ê¥ªË∑É',
    inactive: 'ÈùûÊ¥ªË∑É',
    alumni: 'Ê†°Âèã'
  }
  return map[status] || status
}

const getStatusTagType = (status) => {
  const map = {
    active: 'success',
    inactive: 'warning',
    alumni: 'info'
  }
  return map[status] || ''
}

const getInterests = (interests) => {
  if (!interests) return []
  return interests.split(',').map(item => item.trim()).filter(item => item)
}

const formatDate = (dateString) => {
  if (!dateString) return '-'
  return new Date(dateString).toLocaleString('zh-CN')
}

// Âà§Êñ≠ÊòØÂê¶‰∏∫Â≠¶Áîü
const isStudent = (category) => {
  return ['phd', 'master', 'undergraduate'].includes(category)
}

// Ëé∑ÂèñËÅå‰Ωç/ËÅåÁß∞Ê†áÁ≠æ
const getTitleLabel = (category) => {
  const map = {
    faculty: 'ËÅåÁß∞',
    postdoc: 'ËÅå‰Ωç',
    phd: 'Á†îÁ©∂ÊñπÂêë',
    master: 'Á†îÁ©∂ÊñπÂêë',
    undergraduate: 'Á†îÁ©∂ÂÖ¥Ë∂£',
    alumni: 'Á¶ªÂºÄÂâçËÅå‰Ωç'
  }
  return map[category] || 'ËÅå‰Ωç'
}

// Ëé∑ÂèñËÅå‰Ωç/ËÅåÁß∞Âç†‰ΩçÁ¨¶
const getTitlePlaceholder = (category) => {
  const map = {
    faculty: '‰æãÂ¶ÇÔºöÊïôÊéà„ÄÅÂâØÊïôÊéà',
    postdoc: '‰æãÂ¶ÇÔºöÂçöÂ£´ÂêéÁ†îÁ©∂Âëò',
    phd: '‰æãÂ¶ÇÔºöÊú∫Âô®Â≠¶‰π†ÊñπÂêë',
    master: '‰æãÂ¶ÇÔºöÊ∑±Â∫¶Â≠¶‰π†ÊñπÂêë',
    undergraduate: '‰æãÂ¶ÇÔºöËÆ°ÁÆóÊú∫ËßÜËßâ',
    alumni: '‰æãÂ¶ÇÔºöÂéüÂâØÊïôÊéà'
  }
  return map[category] || 'ËØ∑ËæìÂÖ•ËÅå‰Ωç'
}

// Á±ªÂà´ÂèòÂåñÂ§ÑÁêÜ
const handleCategoryChange = () => {
  // Âè™Âú®Áî®Êà∑ÊâãÂä®Êõ¥ÊîπÊó∂Ê∏ÖÁ©∫Â≠óÊÆµÔºåÂä†ËΩΩÊï∞ÊçÆÊó∂‰∏çÊ∏ÖÁ©∫
  if (isLoadingData.value) return

  // ÂàáÊç¢Á±ªÂà´Êó∂Ê∏ÖÁ©∫‰∏Ä‰∫õÁâπÂÆöÂ≠óÊÆµ
  formData.grade = ''
  formData.major = ''
  formData.supervisor = ''
  formData.honors = ''
  formData.student_count = 0
  formData.current_position = ''
  formData.alumni_category = ''
}

// ÂàùÂßãÂåñ
onMounted(() => {
  loadMembers()
})
</script>

<style scoped>
.header-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.filter-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  flex-wrap: wrap;
  gap: 15px;
}

.filter-left {
  display: flex;
  gap: 15px;
  align-items: center;
}

.filter-right {
  display: flex;
  gap: 10px;
  align-items: center;
}

.interests-tags {
  max-width: 200px;
}

.pagination-row {
  display: flex;
  justify-content: center;
  margin-top: 20px;
}

.avatar-uploader .avatar {
  width: 100px;
  height: 100px;
  border-radius: 6px;
  display: block;
}

.avatar-uploader .el-upload {
  border: 1px dashed var(--el-border-color);
  border-radius: 6px;
  cursor: pointer;
  position: relative;
  overflow: hidden;
  transition: var(--el-transition-duration-fast);
  width: 100px;
  height: 100px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.avatar-uploader .el-upload:hover {
  border-color: var(--el-color-primary);
}

.avatar-uploader-icon {
  font-size: 28px;
  color: #8c939d;
}

@media (max-width: 768px) {
  .filter-row {
    flex-direction: column;
    align-items: stretch;
  }

  .filter-left,
  .filter-right {
    width: 100%;
    justify-content: flex-start;
  }
}
</style>
